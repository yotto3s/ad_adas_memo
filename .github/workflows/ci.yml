name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  # ── Stage 1: Quality gates (no build required) ─────────────────────
  format-check:
    runs-on: ubuntu-24.04
    name: Format Check
    container:
      image: ghcr.io/yotto3s/arcanum-base:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: clang-format (check mode)
        run: ./arcanum/scripts/run-clang-format.sh --check

  lint:
    runs-on: ubuntu-24.04
    name: Lint (clang-tidy)
    container:
      image: ghcr.io/yotto3s/arcanum-base:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (clang-debug for compile_commands.json)
        run: |
          cd arcanum
          cmake --preset clang-debug

      - name: Generate TableGen headers
        run: |
          cd arcanum
          cmake --build build/clang-debug --target ArcOpsIncGen ArcTypesIncGen

      - name: clang-tidy
        run: ./arcanum/scripts/run-clang-tidy.sh build/clang-debug

  # ── Stage 2: Build matrix ──────────────────────────────────────────
  build:
    runs-on: ubuntu-24.04
    name: Build (${{ matrix.preset }})
    needs: [format-check, lint]
    container:
      image: ghcr.io/yotto3s/arcanum-base:latest
    strategy:
      fail-fast: false
      matrix:
        preset: [clang-debug, clang-release, asan, ubsan, coverage]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Remove conflicting libc++abi headers
        run: |
          # LLVM 21's cxxabi.h (from libc++abi-21-dev) conflicts with GCC 13's
          # libstdc++ headers.  Remove it so <cxxabi.h> resolves to GCC's version.
          # TODO: remove this step after rebuilding arcanum-base image with
          # the updated Dockerfile.base that no longer installs libc++abi-21-dev.
          rm -f /usr/lib/llvm-21/include/cxxabi.h \
                /usr/lib/llvm-21/include/__cxxabi_config.h

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-${{ matrix.preset }}-${{ hashFiles('arcanum/lib/**', 'arcanum/include/**', 'arcanum/tools/**', 'arcanum/CMakeLists.txt') }}
          restore-keys: |
            ccache-${{ matrix.preset }}-

      - name: Configure
        run: |
          cd arcanum
          cmake --preset ${{ matrix.preset }}

      - name: Build
        run: |
          cd arcanum
          cmake --build build/${{ matrix.preset }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.preset }}
          path: arcanum/build/${{ matrix.preset }}
          retention-days: 1

  # ── Stage 3: Test matrix ───────────────────────────────────────────
  test:
    runs-on: ubuntu-24.04
    name: Test (${{ matrix.preset }})
    needs: [build]
    container:
      image: ghcr.io/yotto3s/arcanum-base:latest
    strategy:
      fail-fast: false
      matrix:
        preset: [clang-debug, clang-release, asan, ubsan, coverage]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.preset }}
          path: arcanum/build/${{ matrix.preset }}

      - name: Fix artifact permissions
        run: |
          chmod -R +x arcanum/build/${{ matrix.preset }}/bin/ || true

      - name: Run unit tests
        env:
          ASAN_OPTIONS: ${{ matrix.preset == 'asan' && 'detect_leaks=1:halt_on_error=1:allow_user_poisoning=0' || '' }}
        run: |
          cd arcanum
          ctest --preset ${{ matrix.preset }}

      - name: Run lit tests
        env:
          ASAN_OPTIONS: ${{ matrix.preset == 'asan' && 'detect_leaks=1:halt_on_error=1:allow_user_poisoning=0' || '' }}
        run: |
          cd arcanum
          cmake --build build/${{ matrix.preset }} --target check-arcanum-lit

      - name: Create llvm-gcov wrapper
        if: matrix.preset == 'coverage'
        run: |
          cat > arcanum/llvm-gcov.sh << 'GCOV_EOF'
          #!/usr/bin/env bash
          exec llvm-cov-21 gcov "$@"
          GCOV_EOF
          chmod +x arcanum/llvm-gcov.sh

      - name: Generate coverage report
        if: matrix.preset == 'coverage'
        run: |
          cd arcanum
          lcov --capture \
            --directory build/coverage \
            --output-file build/coverage/coverage.info \
            --gcov-tool "$(pwd)/llvm-gcov.sh" \
            --ignore-errors mismatch,inconsistent
          lcov --remove build/coverage/coverage.info \
            '/usr/*' \
            '*/tests/*' \
            '*/build/*' \
            --output-file build/coverage/coverage.info \
            --ignore-errors inconsistent

      - name: Upload to Codecov
        if: matrix.preset == 'coverage'
        uses: codecov/codecov-action@v4
        with:
          files: arcanum/build/coverage/coverage.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
